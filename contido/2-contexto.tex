\chapter{Contexto}
\label{chap:contexto}

\lettrine{N}{este} apartado introdúcense o contexto relevante a este traballo que provee os conceptos básicos necesarios para a súa comprensión.
Para elo descríbese o campo da oftalmoloxía e a imaxe médica, así como o estado da arte en aliñamento de imaxes.
\section{Oftalmoloxía}
\label{sec:Oftalmoloxía}
A oftalmoloxía é a especialidade médica que se encarga do estudo e tratamento do ollo e os seus trastornos.
 O ollo humano é un dos órganos dos que mais dependemos e maior cantidade de información sensorial aporta, e en consecuencia tamén é un dos mais complexos do noso corpo.
Así mesmo, é unha das rexións que proporciona máis datos sobre o estado de saúde do paciente, xa que permite observar directamente os vasos sanguíneos e o tecido neuronal "in-vivo".
 Isto permite a detección temprana de enfermidades, que poden ser diagnosticadas mediante a observación da retina.
\subsection{Anatomía do ollo humano}
\label{subsec:Anatomía do ollo humano}
O ollo encargase de captar a luz e transformala en impulsos eléctricos que se envían ao cerebro.
 Esta información é interpretada polo cerebro, que mediante mecanismos como a atención e a memoria, permite a percepción visual.
 O ollo humano está composto por varias estruturas, cada unha cunha función específica que permite a percepción visual. Entre elas destacan:

 (imagen ilustrativa do ollo con partes señaladas)

 \begin{itemize}
 \item Córnea e Cristalino: actúan xuntas para enfocar a luz na retina. A córnea, situada na parte exterior do ollo, proporciona maior parte da capacidade refractiva, mentres que o cristalino, unha lente flexible, axusta o enfoque para obxectos a diferentes distancias.
 \item Pupila e Iris: regulan a cantidade de luz que entra no ollo. O iris, a parte coloreada do ollo, expándese ou contráese para controlar o tamaño da pupila, o orificio central.
 \item Retina: unha capa de células sensibles á luz (fotorreceptores) que converten os estímulos luminosos en sinais eléctricas, procesados inicialmente na retina mesma.
 \item Nervio óptico: transporta as sinais eléctricas xeradas na retina ata o cerebro, onde se interpretan como imaxes.
 \item Disco óptico: tamén coñecido como "punto cego", é a área onde o nervio óptico sae do ollo; carece de fotorreceptores.
 \item Vasos sanguíneos: distribúen os nutrientes e o osíxeno necesarios á retina e eliminan os seus residuos metabólicos.
 \end{itemize}

 \dots

\subsection{Imaxe oftalmolóxica}
\label{subsec:Imaxe oftalmolóxica}
Existen diversas modalidades de imaxe médica que permiten observar o ollo, cada unha con diferentes propiedades e aplicacións. 
As mais utilizadas son a fotografía de fondo de ollo (retinografía), a tomografía de coherencia óptica (OCT) e a angiografía con fluoresceína.

\subsection{Retinografía}
\label{subsec:Retinografía}
Este traballo céntrase na retinografía xa que é a mais común.
Isto é débese en gran parte á súa accesibilidade, requerindo equipo maís barato e menor entrenamento comparada cas outras modalidades. 
Ademais, é unha técnica non invasiva e rápida de realizar, o que a fai preferible na maioría dos casos.

Para realizala utilízase unha cámara especial denominada retinógrafo, e xeralmente require da previa dilatación da pupila do paciente.
Desta forma permítese maior entrada de luz nos ollos, o que provoca unha mellor visualización da retina e mellora a calidade da imaxe.
Un especialista pode analizar a retinografía para detectar signos de enfermidades como a retinopatía diabética, a hipertensión ou a dexeneración macular.


(imagen retina con partes señaladas)



\section{Rexistro de imaxes}
\label{sec:Rexistro de imaxes}
O rexistro de imaxes é un proceso que consiste en, sobre dúas ou mais imaxes, determinar a correspondencia espacial entre elas
 e alinealas nun sistema de coordenadas común, co obxetivo de que as características de interese se atopen na mesma posición.

Estas imaxes poden variar a nivel temporal, espacial, de dimensión ou de modalidade.

O rexistro de imaxes ten utilidade en moitos campos diferentes como a imaxe satelital, xeografía, robótica... \cite{goshtasby2017theory} mais o 
campo da imaxe médica é dos mais interesantes póla súa aplicación práctica e é o que se aborda neste traballo.

No ámbito da saúde un rexistro adecuado pode empregarse para comparar imaxes dun mesmo paciente tomadas en distintos momentos, en distintas modalidades ou para comparar entre diferentes pacientes.
Isto permite a revisión do avance dunha enfermidade ao longo do tempo, a fusión de imaxes de distintas modalidades ou a detección de patróns comúns entre distintos individuos.
A fusión de imaxes permite interpretar moito mellor a información dispoñible nelas, e é de gran axuda para guiar aos médicos na toma de decisións.
Tamén é útil para correxir os movementos involuntarios do paciente durante a adquisición de imaxes, como no caso da respiración en imaxes de pulmóns.

Tamén é fundamental para a intervención guiada por imaxe (telecirurxía, radioterapia guiada por imaxe (IGRT)....) que non 
podería funcionar sen a utilización axeitada de técnicas de rexistro de imaxes. \cite{wang2022neuralrenderingstereo3d}

Ata recentemente, gran parte do traballo de rexistro facíase de forma manual por expertos, 
e dependía das habilidades do profesional para detectar as características de interese e realizar o aliñamento.
Isto facía que o proceso fose lento e propenso a erros, ademais de pouco práctico para grandes volumes de imaxes.
Existen diversos métodos para realizar aliñamento de imaxes, que poden estar automatizados en maior ou menor medida, sendo gran parte deles híbridos.

No caso de trabllar con dúas imaxes, a imaxe de referencia denomínase imaxe fixa (f) e a imaxe que se quere rexistrar imaxe móbil (m).
Dependendo do tipo de transformación utilizada esta pode ser clasificada en ríxida, afín ou deformable.
A ríxida tan só permite rotación e traslación, mentres que a afín permite ademais escalado e cizallamento.
Ámbas transformacións poden ser representadas por unha matriz de 2 dimensións xa que son deformacións lineais.
Ao contrario, a transformación deformable é non lineal, polo que require dunha dimensión adicional ás da imaxe a rexistrar (unha imaxe de 2d require unha matriz 3d).

Esta matriz denomínase campo de vectores de deformación (DFV), e permite representar deformacións locais na imaxe, facendoa moito mais flexible para representar transformacións complexas e detalladas.
\dots más de DFV \dots

Dentro da deformables poden distinguirse entre transformacións difeomórficas e non difeomórficas.

As transformacións difeomórficas son aquelas que son continuas, invertibles e diferenciables en todo o seu dominio.
Se non tén esta característica, non se pode garantir que a información da imaxe móbil se manteña intacta tras a transformación.
Por iso as transformacións difeomórficas son preferidas en moitos casos \cite{han2022diffeomorphicimageregistrationneural}, 


\subsection{Estado da arte}
\label{subsec:Estado da arte}

Tradicionalmente impregáronse métodos iterativos baseádos na extracción de características 
seguido dun proceso de optimización entre cada par de imaxes. 
Isto require recoñecer as características de interese en cada imaxe e utilizar unha métrica de similitude 
para determinar a calidade do rexistro.
O proceso consiste en calcular o grado de semellanza entre as imaxes e 
actualizar os parámetros da transformación de forma iterativa utilizando algún mecanismo de optimización
 ata que se cumpran os criterios de terminación.
O resultado final pode ser os parámetros da transformación ou a imaxe fusionada.
A figura \ref{fig:rexistro_iterativo} mostra un diagrama do proceso de rexistro iterativo.

A principal desventaxa destes métodos é a súa lentitude, xa que requiren de moitas iteracións para converxer.
Non obstante, son moi precisos e robustos, polo que aínda se empregan en moitos casos.

\begin{figure}[hp!]
    \centering
    \begin{tikzpicture}[node distance=2cm, scale=0.8, every node/.style={transform shape}]
        % Nodes
        \node (imageFixa) [process] {Imaxe Fixa};
        \node (imageMobil) [process, right of=imageFixa, xshift=3cm] {Imaxe Móbil};
        \node (featureExtraction) [process, below of=imageFixa, yshift=-1cm] {Cálculo de medida de similitude};
        \node (parameterUpdate) [process, below of=featureExtraction, yshift=-1cm] {Actualización de Parámetros};
        \node (applyTransformation) [process, below of=parameterUpdate, yshift=-1cm] {Aplicar a Transformación};
        \node (criteriaCheck) [decision, below of=applyTransformation, yshift=-1cm] {Criterios Cumplidos?};
        \node (result) [process, below of=criteriaCheck, yshift=-1cm] {Resultado};
        % Arrows
        \draw [arrow] (imageFixa) -- (featureExtraction);
        \draw [arrow] (imageMobil) -- (featureExtraction);
        \draw [arrow] (featureExtraction) -- (parameterUpdate);
        \draw [arrow] (parameterUpdate) -- (applyTransformation);
        \draw [arrow] (applyTransformation) -- (criteriaCheck);
        \draw [arrow] (criteriaCheck) -- node[anchor=west] {Sí} (result);
        \draw [arrow] (criteriaCheck.east) -- ++(1,0) node[anchor=south, xshift=0.5cm] {No} |- (featureExtraction.east);
    \end{tikzpicture}
\caption{Proceso de rexistro de imaxes iterativo}
\label{fig:rexistro_iterativo}
\end{figure}

\subsection{Métodos de aprendizaxe profunda}
\label{subsec:Métodos de aprendizaxe profunda}

Ca chegada dos métodos de aprendizaxe profunda á imaxe médica, comezaron a empregarse redes neuronais para realizar o aliñamento de imaxes.
Estos métodos tenden a ser mais rápidos que os métodos convencionais, a custo de algo de precisión. 
Ademais, estos métodos requiren dunha gran cantidade de datos para ser adestrados, 
o que pode ser unha desventaxa xa que en moitos casos non se dispoñen de bases de datos anotadas do tamaño necesario.

Unha aproximación común é empregar estes conxuntos de datos para optimizar unha CNN que,
 dadas dúas imaxes novas e non vistas, predice o DFV correspondente.

Durante o proceso de entrenamento, a rede ten acceso aos DFVs ca deformación correcta,
 ou pódense obter indirectamente a través da optimización dunha métrica de similitude de imaxes [].

Existen moitas extensións a esta aproximación, como o uso de múltiples etapas ou o uso de redes adversarias durante o entrenamento.

Tamén se propuxeron métodos híbridos que combinan a optimización iterativa ca aprendizaxe profunda, 
entrenando unha CNN nova por cada parella de imaxes. Desta forma conséguese evitar a necesidade de grandes conxuntos de datos para o adestramento.

Os métodos de aprendizaxe profunda poden ser clasificados en dous tipos según se requiran de DFVs anotados ou non na etapa de entrenamento: 
supervisados (requíren de DFVs anotados) e non supervisados (non requíren de DFVs anotados).

\subsubsection{Métodos Supervisados}
\label{subsubsec:Métodos Supervisados}

Existen dúas subcategorías según o grado de supervisión utilizado na etapa de entrenamento: totalmente supervisados ou débilmente supervisados.
O rexistro totalmente supervisado fai uso de DVFs de referencia para supervisar o proceso de aprendizaxe.
 O termo de perda adoita basearse na discrepancia entre os DVFs de referencia e os DVFs predicidos.
 
No lugar dos DVFs de referencia, o rexistro débilmente supervisado pode utilizar outras etiquetas de referencia implícitas.
 Estas etiquetas non se basan en datos explícitos como os DFVs, senón que utilizan información indirecta para guiar o proceso de rexistro, como a semellanza entre as imaxes ou restricións baseadas na forma ou límites anatómicos das estruturas.
 Máis de dous tipos de datos de referencia son frecuentemente utilizados para adestrar modelos de rexistro débilmente supervisados. \cite{bharati2022deeplearningmedicalimage}
\dots

\subsubsection{Métodos Non Supervisados}
\label{subsubsec:Métodos Non Supervisados}

Un dos maiores retos para traballar de forma automática con imaxes médicas é a recolección de datos anotados de calidade para o adestramento \cite{medicalimageanalysis}.
A creación de conxuntos de DFVs anotados é un proceso laborioso e costoso, que normalmente sólo póde ser executado por especialistas, polo que os métodos de rexistro non supervisados son de gran interese.
Xa que a imaxen fixa e a imaxe móbil xa conteñen toda a información necesaria para un rexistro correcto, os métodos non supervisados parecen mais adecuados para a tarefa de rexistro.
De forma similar aos métodos iterativos, é común empregar unha métrica de similitude entre as imaxes xunto con un termo de regularización para guiar o proceso de optimización evitando caer en transformación non realistas.

\cite{Balakrishnan_2019voxelmorph} é un dos métodos mais recoñecidos de rexistro de imaxes non supervisado facendo uso de CNNs.

O rexistro non supervisado de imaxes médicas utilizando GANs é unha subcategoría desta técnica.



\subsubsection{Métodos baseasdos en Reinforcement Learning}
\label{subsubsec:Métodos baseados en Reinforcement Learning}


\subsection{Representación Neuronais Implícitas}
 \label{subsec:Representación Neuronais Implícitas}
 
 As representacións neuronais implícitas están a recibir cada vez máis atención da comunidade médica \cite{molaei2023implicitneuralrepresentationmedical}. 
 Son un paradigma innovador que permite modelar sinais continuas mediante funcións parametrizadas por redes neuronales.
 Este enfoque utilízase ampliamente en áreas como visión por computador, xa que a diferencia das representaciones discretas tradicionais (vóxeles, píxeles...), 
 representar o sinal como una función continua ten múltiples vantaxes:

 É moito mais eficiente en memoria debido á compresión da información que realizan. Ao mesmo tempo, permite un nivel de detalle non limitado pola resolución da imaxe, senón pola capacidade da rede. 
 Ademais, as representacións continuas son diferenciables, o que permite o cálculo de gradientes e derivadas de forma analítica en lugar de ter que aproximalos por diferencias finitas.
 Isto tamén implica que as representacións implícitas son independentes da resolución, o que permite a reconstrucción en calquer escala espacial.
 
 No contexto da imaxen médica, as representacións implícitas son útiles para as tarefas de imaxe inversa, que requiren a reconstrucción de imaxes a partir de datos incompletos ou ruidosos. 
 No caso de \cite{shen2023nerpimplicitneuralrepresentation}, propuxeron unha representación implícita para a reconstrucción de imaxes de resonancia magnética a partir de datos incompletos facendo uso de redes implícitas, 

\cite{mildenhall2020nerfrepresentingscenesneural} propuxeron unha representación implícita para a representación de escenas 3D, 
 optimizando unha función volumétrica continua que modela a densidade de volume e a radiancia emitida en cada punto do espazo.
 Utilizando un MLP, cuxa entrada é unha única coordenada continua 5D (localización espacial (x, y, z) e dirección de visión (θ, φ)) 
 e cuxa saída é a densidade de volume e a radiancia emitida dependente da vista nesa localización espacial. 
A única entrada necesaria para optimizar a súa representación é un conxunto de imaxes con poses de cámara coñecidas. 
Demostrando que as representacións implícitas están capacitadas para modelar escenas 3D complexas con alta fidelidade visual.
 
Isto é de de gran utilidade para a ciruxía asistida por robots, como no caso de \cite{inrrobots}, onde
propuxeron un método para a reconstrucción de tecidos brandos en cirurxía robótica a partir de vídeos estereoscópicos endoscópicos con un único águlo de referencia. 
Para iso fan uso de campos neuronais implícitos similares aos de NeRF, conseguindo renderizado neuronal para a reconstrución de escenas cirúrxicas.

\cite{teleoperatdrob}, \cite{graphimplrbts} también interesantes pero no puedo acceder a ellos.

\cite{velikova2024implicitneuralrepresentationsbreathingcompensated} and \cite{yu2024neuraltrajectorymodelimplicit} casos de uso interesantes.

Tamén se empregan en segmentación, compresión e síntesis de imaxes.

 No caso do aliñamento de imaxes, buscase optimizar a función que mapea cada localización da imaxe fixa a unha localización da móbil.
 
\section{IDIR}
\label{sec:IDIR}
IDIR (Implicit Deformable Image Registration) é un método de aliñamento de imaxes baseado en redes neuronais. 
A súa principal diferenza frente a unha rede convolucional tradicional é que, 
en lugar de predicir a transformación entre imaxes, optimízase unha rede para esta mesma represente esta transformación.

O que \cite{wolterink2021implicit} propón é optimizar directamente o DFV facendo uso
 dunha representación implícita, de forma que a deformación está representada nos propios pesos dunha MLP.

\subsubsection{Arquitectura}
\label{subsubsec:Arquitectura}

Faise uso dun MLP de 3 capas, e determinaron experimentalmente que obtiñan mellor resultado con 256 unidades por capa que 128.
Por cada epoch de entrenamento (2500 en total), 10000 puntos son muestreados aleatoriamente do espazo de coordenadas dentro da máscara.
O término de perda é a 'normalized cross-correlation' entre os valores dos píxeles muestreados na imaxe fixa e os correspondentes da imaxe móbil.
Utilizan Adam de optimizador, cun learning rate de 0.0001.

\subsubsection{Función de activación}
\label{subsubsec:Función de activación}

Unha elección estándar para a función de activación é ReLU: σ(x) = max(0, x). 
Non obstante, para redes de representación implícita como ca que estamos traballando, esta ten unha serie de desventaxas.

Sen embargo, as ReLUs teñen un sesgo cara a sinais de baixa frecuencia \cite{rahaman2019spectralbiasneuralnetworks}, 
 o que significa que o modelo pode ter dificultades para representar pequenas deformacións locais no rexistro de imaxes.
 
Existen varias formas de superar este sesgo, como preprocesar as coordenadas de entrada con funcións de activación periódicas \cite{mildenhall2020nerfrepresentingscenesneural} 
ou substituír a función de activación ReLU por unha función de activación periódica \cite{sitzmann2020implicitneuralrepresentationsperiodic}.
Neste traballo escollemos a segunda opción, utilizando unha función de activación periódica para obter un modelo de tipo SIREN, σ(x) = sin(x).
Unha vantaxe engadida das funcións de activación periódicas nas redes SIREN é que poden ser diferenciadas varias veces, 
o que expande substancialmente o conxunto de termos de regularización que se poden empregar na rede, como veremos na seguinte sección.

\cite{mildenhall2020nerfrepresentingscenesneural} non utiliza unha función de activación periódica, mais para a representación adecuada de zonas de alta frecuencia 
utilizaron positional encoding para incorporálas de forma implícita na rede con bós resultados. \ref{chap:Positional Encoding}

\subsubsection{Termos de regularización}
\label{subsubsec:Termos de regularización}

Debido a que el registro de imágenes deformables es un problema mal planteado (ill-posed problem**), 
es común regularizar el DVF para evitar deformaciones poco realistas.
 Los métodos de registro basados en redes neuronales convolucionales (CNN) representan los DVF 
 como muestras en una cuadrícula de vóxeles, y por lo tanto, solo pueden aproximar gradientes espaciales
 mediante esquemas de diferencias finitas. Esto conlleva errores de discretización y pérdidas de precisión.

Facendo uso de representacións implícitas, todas as operación son diferenciables, e os gradientes poden
 ser computados de forma analítica en lugar de ter que aproximalos.
Utilizando ReLU como función de activación, a rede é diferenciable unha vez, mentres que utilizando
 unha función de activación periódica (como SIREN), a rede é diferenciable varias veces.
Desta forma, podemos calcular calquera número de termos de regularización e incluilos na optimización da rede.

Algúns exemplos de termos de regularización que se poden empregar son:
\begin{itemize}
    \item Jacobian regularizer: 
    O determinante Jacobiano da transformación (det ∇Φ) nunha localización x é un indicador de estiramento ou compresión local.
    Un determinante Jacobiano negativo indica que está a ocurrir folding e a transformación non será invertible.
    \dots

    \item Hyperelastic regularizer
    Tamén se póden engadir restricións ao DVF con este termo proposto por \cite{HyperelasticRegularization}.
    Consiste en tres termos, un termo de lonxitude, un termo de área e un termo de volumen co obxetivo de controlar variacións nestes aspectos.
    O termo de lonxitude penaliza a variación da lonxitude dos vectores do DVF e está controlado pola matriz do Jacobiano da transformación.
    A matriz de cofactores e o determinante da matriz do Jacobiano da transformación controlan a área e o volume respectivamente, 
    penalizando o crecemento e a contracción por igual.
    \dots

    \item Bending energy penalty
    Pódese impoñer a suavidade do DVF empregando esta penalización proposta en (Rueckert et al., 1999).
    Require que as segundas derivadas do DVF sexan pequenas en todo o dominio, 
    polo que non pode ser utilizado nunha rede que utilice ReLU como función de activación (a segunda derivada de unha ReLU é sempre igual a 0).
    \dots
\end{itemize}


\subsubsection{Método}
\label{subsubsec:Método}

Sendo o obxetivo encontrar unha transformación espacial óptima entre a imaxe fixa e a imaxe móbil,
é necesario obter a función de deformación  Φ(x) = u(x) + x que mapea cada coordenada x na imaxe fixa a unha coordenada na imaxe móbil, 
de forma que a coordenada x na imaxe fixa corresponda anatomicamente á coordenada Φ(x) na imaxe móbil.
Este problema pode ser formulado como un problema de optimización onde Ldata é unha métrica de similitude entre as imaxes fixa e móbil, Lreg é un termo de regularización na transformación Φ, e α é un termo de ponderación.
\begin{equation}
   \hat{\Phi} = \operatorname*{Arg\,min}_{\Phi} L_{data}(M \circ \Phi, F) + \alpha L_{reg}(\Phi)
\end{equation}

A aportación clave é que a transformación Φ está implícitamente representada nunha rede neuronal.

Comparado cunha CNN tradicional, esta rede non recibe valores de intensidade de píxel como entrada,
senón que recibe coordenadas espaciais (continuas) e devolve unha nova coordenada.
Xa que os pesos da rede definen a transformación, estos poden ser optimizados directamente 
facendo uso dunha métrica de similitude como función de perda.

Parametrizar a función de deformación como unha INR dentro dun MLP ten varias vantaxes para o rexistro de imaxes.
En primeiro lugar, a representación da transformación é continua e polo tanto independente da resolución da imaxe, 
grazas a iso o mesmo modelo poder ser empregado para imaxes de calquer tamaño, ao contrario dunha CNN tradicional 
que ten que ser adaptada para cada resolución.

Segundo, facelo desta forma permite aproveitar as capacidades de librerías como PyTorch para calcular os gradientes da transformación respecto das coordenadas.
Isto permite obter gradientes máis precisos que as aproximacións por diferencias finitas 
e permite aproveitar unha gran cantidade de literatura sobre regularización eficientes en imaxes médicas.

Terceiro, pódese modificar a función de activación empregada na rede para axustala ás necesidades particulares da tarefa de rexistro de imaxes.
Neural Tangent Kernel (NTK) es un concepto que describe cómo un modelo de red neuronal responde a cambios en sus parámetros durante el entrenamiento,
e dependendo da función de activación empregada, o NTK varía e a rede pode ser máis ou menos sensible a certas deformacións.

Finalmente, entrenaráse unha nova rede por cada parella de imaxes, sendo esta unha rede bastante pequena en comparación e precindindo así da necesidade de grandes conxuntos de datos para o seu adestramento.



\section{Traballo proposto}
\label{sec:Traballo proposto}

Baseándose no framework introducido por \cite{wolterink2021implicit},
 propónse modificalo para adaptalo a imaxes médicas de retina.
